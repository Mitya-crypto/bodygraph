require('dotenv').config({ path: '.env.local' })

const TelegramBot = require('node-telegram-bot-api')

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '8296309758:AAFgJTxZ_Sc6qmOTGMwjab9V6LvkhhTlYm4'
const PORT = process.env.PORT || 3001
const WEBHOOK_URL = process.env.TELEGRAM_WEBHOOK_URL || `https://your-domain.com/webhook`

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
const bot = new TelegramBot(BOT_TOKEN, { 
  polling: {
    interval: 1000,
    autoStart: true,
    params: {
      timeout: 10
    }
  }
})

console.log('ü§ñ Telegram Bot –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É', PORT)
console.log('üì± Bot Token:', BOT_TOKEN.substring(0, 10) + '...')

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id
  const firstName = msg.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
  
  const welcomeMessage = `üëã –ü—Ä–∏–≤–µ—Ç, ${firstName}!

üåå –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>Cosmic BodyGraph</b> - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ª–∏—á–Ω–æ—Å—Ç–∏!

üîÆ <b>–ß—Ç–æ —è —É–º–µ—é:</b>
‚Ä¢ üìä –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è - —Ä–∞—Å—á–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª
‚Ä¢ üß¨ Human Design - –∞–Ω–∞–ª–∏–∑ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–∏–ø–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚Ä¢ ‚≠ê –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è - –Ω–∞—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç

üöÄ <b>–ö–∞–∫ –Ω–∞—á–∞—Ç—å:</b>
1. –ù–∞–∂–º–∏ /profile —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
2. –ò—Å–ø–æ–ª—å–∑—É–π /modules –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞
3. –ü–æ–ª—É—á–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç!

üí´ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/profile - —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
/modules - –≤—ã–±—Ä–∞—Ç—å –º–æ–¥—É–ª—å –∞–Ω–∞–ª–∏–∑–∞
/help - –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å

<i>–ù–∞—á–Ω–∏ —Å–≤–æ–µ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</i>`

  bot.sendMessage(chatId, welcomeMessage, { parse_mode: 'HTML' })
})

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id
  
  const helpMessage = `üÜò <b>–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</b>

üìã <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/profile - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
/modules - –≤—ã–±–æ—Ä –º–æ–¥—É–ª–µ–π –∞–Ω–∞–ª–∏–∑–∞
/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

üîÆ <b>–ú–æ–¥—É–ª–∏ –∞–Ω–∞–ª–∏–∑–∞:</b>

<b>üìä –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è:</b>
‚Ä¢ –ß–∏—Å–ª–æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏
‚Ä¢ –ß–∏—Å–ª–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
‚Ä¢ –ß–∏—Å–ª–æ –¥—É—à–∏
‚Ä¢ –ß–∏—Å–ª–æ –ª–∏—á–Ω–æ—Å—Ç–∏
‚Ä¢ –ë–∏–æ—Ä–∏—Ç–º—ã –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

<b>üß¨ Human Design:</b>
‚Ä¢ –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏–ø (Generator, Projector, Manifestor, Reflector)
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
‚Ä¢ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª—å –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
‚Ä¢ –ò–Ω–∫–∞—Ä–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π –∫—Ä–µ—Å—Ç

<b>‚≠ê –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è:</b>
‚Ä¢ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞
‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –ø–ª–∞–Ω–µ—Ç
‚Ä¢ –î–æ–º–∞ –∏ –∑–Ω–∞–∫–∏
‚Ä¢ –¢—Ä–∞–Ω–∑–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç
‚Ä¢ –ê—Å–ø–µ–∫—Ç—ã –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ

üí° <b>–°–æ–≤–µ—Ç—ã:</b>
‚Ä¢ –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —É–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∏ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º

<i>–ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å? –ù–∞–ø–∏—à–∏—Ç–µ /start</i>`

  bot.sendMessage(chatId, helpMessage, { parse_mode: 'HTML' })
})

// –ö–æ–º–∞–Ω–¥–∞ /profile
bot.onText(/\/profile/, (msg) => {
  const chatId = msg.chat.id
  
  const profileMessage = `üë§ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º</b>

üìù <b>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –Ω—É–∂–Ω—ã:</b>
‚Ä¢ –ü–æ–ª–Ω–æ–µ –∏–º—è
‚Ä¢ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–ì–ì–ì–ì-–ú–ú-–î–î)
‚Ä¢ –í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è (–ß–ß:–ú–ú)
‚Ä¢ –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è (–≥–æ—Ä–æ–¥, —Å—Ç—Ä–∞–Ω–∞)

üåç <b>–ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b>
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–æ–≤.

üì± <b>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å:</b>
–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

üîó <b>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</b>
<a href="http://localhost:${PORT}">–û—Ç–∫—Ä—ã—Ç—å Cosmic BodyGraph</a>

<i>–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –±–æ—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞!</i>`

  bot.sendMessage(chatId, profileMessage, { 
    parse_mode: 'HTML',
    disable_web_page_preview: true
  })
})

// –ö–æ–º–∞–Ω–¥–∞ /modules
bot.onText(/\/modules/, (msg) => {
  const chatId = msg.chat.id
  
  const modulesMessage = `üîÆ <b>–ú–æ–¥—É–ª–∏ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</b>

<b>üìä –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è</b>
–ê–Ω–∞–ª–∏–∑ —á–∏—Å–µ–ª –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏:
‚Ä¢ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π –ø—É—Ç—å –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
‚Ä¢ –°–ø–æ—Å–æ–±—ã —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏—è
‚Ä¢ –î—É—à–µ–≤–Ω—ã–µ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—è
‚Ä¢ –í–Ω–µ—à–Ω—è—è –ª–∏—á–Ω–æ—Å—Ç—å
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ü–∏–∫–ª—ã

<b>üß¨ Human Design</b>
–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –≤–∞—à–µ–≥–æ —Ç–µ–ª–∞:
‚Ä¢ –¢–∏–ø: –∫–∞–∫ –≤—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç–µ —Å –º–∏—Ä–æ–º
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ –ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç: –∫–∞–∫ –¥–æ–≤–µ—Ä—è—Ç—å —Å–µ–±–µ
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª—å: –≤–∞—à–∞ —Ä–æ–ª—å –≤ –∂–∏–∑–Ω–∏
‚Ä¢ –¶–µ–Ω—Ç—Ä—ã: –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏

<b>‚≠ê –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è</b>
–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:
‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –ø–ª–∞–Ω–µ—Ç –≤ –∑–Ω–∞–∫–∞—Ö
‚Ä¢ –î–æ–º–∞ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è
‚Ä¢ –¢—Ä–∞–Ω–∑–∏—Ç—ã –∏ —Ç–µ–∫—É—â–∏–µ –≤–ª–∏—è–Ω–∏—è
‚Ä¢ –ê—Å–ø–µ–∫—Ç—ã –º–µ–∂–¥—É –ø–ª–∞–Ω–µ—Ç–∞–º–∏
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

üîó <b>–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑:</b>
<a href="http://localhost:${PORT}/modules">–í—ã–±—Ä–∞—Ç—å –º–æ–¥—É–ª—å</a>

<i>–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –≤–∞—à—É –∫–æ—Å–º–∏—á–µ—Å–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å!</i>`

  bot.sendMessage(chatId, modulesMessage, { 
    parse_mode: 'HTML',
    disable_web_page_preview: true
  })
})

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
  const chatId = msg.chat.id
  const text = msg.text
  
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
  if (text && text.startsWith('/')) {
    return
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  const responseMessage = `ü§ñ –°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ!

üí° <b>–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/profile - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º  
/modules - –≤—ã–±–æ—Ä –∞–Ω–∞–ª–∏–∑–∞
/help - –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å

üîó <b>–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</b>
<a href="http://localhost:${PORT}">Cosmic BodyGraph</a>

<i>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞!</i>`

  bot.sendMessage(chatId, responseMessage, { 
    parse_mode: 'HTML',
    disable_web_page_preview: true
  })
})

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error.message)
  // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å polling —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    console.log('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ polling...')
    bot.stopPolling()
    setTimeout(() => {
      bot.startPolling()
      console.log('‚úÖ Polling –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ')
    }, 2000)
  }, 5000)
})

bot.on('error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞:', error.message)
})

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...')
  bot.stopPolling()
  process.exit(0)
})

process.on('SIGTERM', () => {
  console.log('\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...')
  bot.stopPolling()
  process.exit(0)
})

console.log('‚úÖ Telegram Bot —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!')
console.log('üì° Polling —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω')
console.log('üîó –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://localhost:' + PORT)
